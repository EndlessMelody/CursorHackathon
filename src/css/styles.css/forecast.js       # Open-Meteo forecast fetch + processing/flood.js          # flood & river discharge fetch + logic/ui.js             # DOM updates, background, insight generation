// src/js/forecast.js
async function fetchForecast(lat, lon, model) {
    const params = new URLSearchParams({
        latitude: lat,
        longitude: lon,
        hourly: 'temperature_2m,relativehumidity_2m,windspeed_10m,precipitation_probability,precipitation',
        timezone: 'auto',
        forecast_days: 3
    });
    if (model) params.set('forecast_model', model);

    const response = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`);
    if (!response.ok) throw new Error('Failed to fetch forecast data');
    return await response.json();
}

// src/js/flood.js
async function fetchFloodData(lat, lon) {
    const floodUrl = `https://flood-api.open-meteo.com/v1/flood?latitude=${lat}&longitude=${lon}&daily=river_discharge&forecast_days=1`;
    const response = await fetch(floodUrl);
    if (!response.ok) throw new Error('Failed to fetch flood data');
    return await response.json();
}

// src/js/ui.js
function updateDOMWithForecast(data) {
    const times = data.hourly.time.map(t => new Date(t));
    const temps = data.hourly.temperature_2m;
    const hums = data.hourly.relativehumidity_2m;
    const winds = data.hourly.windspeed_10m;
    const rainp = data.hourly.precipitation_probability;

    // Update UI elements with fetched data
    placeEl.textContent = `Lat ${lat.toFixed(3)}, Lon ${lon.toFixed(3)}`;
    timeNowEl.textContent = times[0].toLocaleString();
    tempNowEl.textContent = `${Math.round(temps[0])}°C`;
    condsNowEl.textContent = 'Hourly forecast';
    humNowEl.textContent = `${Math.round(hums[0])}%`;
    windNowEl.textContent = `${winds[0].toFixed(1)} m/s`;
    rainNowEl.textContent = `${Math.round(rainp[0])}%`;
}

function generateInsight(temp, hum, rainProb, wind) {
    const msgs = [];
    if (rainProb > 60) msgs.push('High chance of rain — bring umbrella.');
    else if (rainProb > 30) msgs.push('Light showers possible.');
    if (temp >= 35) msgs.push('Very hot — stay hydrated.');
    else if (temp >= 30) msgs.push('Hot day — wear light clothes.');
    else if (temp <= 5) msgs.push('Very cold — dress warmly.');
    else if (temp <= 15) msgs.push('Cool — consider jacket.');
    if (hum > 80) msgs.push('High humidity — muggy.');
    if (wind > 10) msgs.push('Strong winds expected.');
    return msgs.length ? msgs.join(' ') : 'Weather looks mild.';
}

function updateBackground(insight) {
    const lowerInsight = insight.toLowerCase();
    let bgUrl = 'https://images.unsplash.com/photo-1501973801540-537f08ccae7d?auto=format&fit=crop&w=1600&q=80';
    insightBackgrounds.forEach(item => {
        if (lowerInsight.includes(item.keyword.toLowerCase())) bgUrl = item.url;
    });
    document.body.style.backgroundImage = `url(${bgUrl})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
}